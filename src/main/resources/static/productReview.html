<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Reviews</title>
    <style>
      /* 基础的样式，去除多余的颜色，保持简洁 */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      
      table, th, td {
        border: 1px solid black;
      }
      
      th, td {
        padding: 8px;
        text-align: left;
      }
      
      form {
        margin-bottom: 20px;
      }
      
      label, select, input, textarea {
        display: block;
        margin-bottom: 10px;
        width: 100%;
        max-width: 400px;
      }
      
      button {
        display: block;
        margin-top: 10px;
        padding: 10px;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        max-width: 400px;
      }
      
      button:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>
    
    <!-- 评论提交部分 -->
    <div>
      <h3>Submit a Review</h3>
      <form id="reviewForm">
        <label for="productSelect">Product:</label>
        <select id="productSelect"></select>
        
        <label for="rating">Rating (1-5):</label>
        <input type="number" id="rating" name="rating" min="1" max="5" required>
        
        <label for="comment">Comment:</label>
        <textarea id="comment" name="comment" required></textarea>
        
        <button type="submit">Submit</button>
      </form>
    </div>
    
    <!-- 评论显示部分 -->
    <div>
      <h3>Product Reviews</h3>
      <select id="reviewProductSelect"></select> <!-- 用于选择产品查看其评论 -->
      <table id="reviewTable">
        <thead>
        <tr>
          <th>User</th>
          <th>Rating</th>
          <th>Comment</th>
        </tr>
        </thead>
        <tbody>
        <!-- 评论数据将插入到这里 -->
        </tbody>
      </table>
    </div>
    
    <script>
      // 加载所有产品并将其插入到下拉框中
      async function loadProducts() {
        const response = await fetch('/api/products'); // 从后端获取所有产品
        const products = await response.json();
        const productSelect = document.getElementById('productSelect');
        productSelect.innerHTML = products.map(product => `
                <option value="${product.id}">${product.name}</option>
            `).join('');
      }
      
      // 加载产品评论
      async function loadReviews(productId) {
        const response = await fetch(`/api/reviews/product/${productId}`);
        const reviews = await response.json();
        
        const reviewTableBody = document.querySelector('#reviewTable tbody');
        reviewTableBody.innerHTML = reviews.map(review => `
                <tr>
                    <td>${review.userId}</td> <!-- 可以改为真实用户信息 -->
                    <td>${review.rating}</td>
                    <td>${review.comment}</td>
                </tr>
            `).join('');
      }
      
      // 加载所有产品到评论选择下拉框并设置默认行为
      async function loadProductsForReview() {
        const response = await fetch('/api/products');
        const products = await response.json();
        const productSelect = document.getElementById('reviewProductSelect');
        productSelect.innerHTML = products.map(product => `
                <option value="${product.id}">${product.name}</option>
            `).join('');
        
        // 默认加载第一个产品的评论
        loadReviews(products[0].id);
        
        // 切换产品时加载不同产品的评论
        productSelect.addEventListener('change', function() {
          loadReviews(this.value);
        });
      }
      
      // 提交评论
      document.getElementById('reviewForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const productId = document.getElementById('productSelect').value;
        const rating = document.getElementById('rating').value;
        const comment = document.getElementById('comment').value;
        
        const reviewData = { rating, comment }; // 发送评论数据，不传递 userId
        
        try {
          await fetch(`/api/reviews/product/${productId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(reviewData)
          });
          alert('Review submitted successfully!');
          loadReviews(productId); // 提交后重新加载该产品的评论
        } catch (error) {
          console.error('Error submitting review:', error);
        }
      });
      
      // 初始化页面，加载产品和评论
      loadProducts();
      loadProductsForReview();
    </script>
  
  </body>
</html>